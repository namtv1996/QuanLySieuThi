!function(t){function n(t,n,a,o,e,i){function c(){0===t.inwardStock.Status?i.go("inwardStockEdit",{id:t.inwardStock.VoucherID}):o.displayWarning("Phiếu nhập đã phát sinh giao dịch. Không thể sửa đổi !!")}function r(a){e.confirm("<h4>Bạn có chắc muốn xóa?</h4>").then(function(){var e={params:{id:a}};n.get("api/purchaseInvoice/getbyid/"+a,null,function(a){var i={};i=a.data;var c=i.ObjectID,r=i.TotalPaymentAmount;0===i.PaymentStatus?n.del("api/purchaseInvoice/deleteInwardStock",e,function(){n.get("api/vendor/getbyid/"+c,null,function(t){var a={};a=t.data,a.ObjectID===c&&(a.Debt=a.Debt-r,n.put("api/vendor/update",a))},function(){console.log("Ko cập nhật đk công nợ !!")}),o.displaySuccess("Đã xóa hóa đơn !!"),t.GetVoucherById()},function(){o.displayError("Xóa không thành công")}):o.displayWarning("Hóa đơn đã thanh toán. Không thể xóa hóa đơn này này !!")},function(){console.log("load items failed")})})}function u(){n.get("api/purchaseInvoice/getPurchaseReturnByISIDAndStt/"+a.id,null,function(n){if(t.listPurchaseReturnByISID=n.data,t.listPurchaseReturnByISID.length<=0)t.displayReturn="none";else{t.displayReturn="block";for(var a=0,o=0;o<t.listPurchaseReturnByISID.length;o++)a+=t.listPurchaseReturnByISID[o].TotalPurchaseQuantity;a>=t.inwardStock.TotalPurchaseQuantity&&(t.displayReturn1="none")}},function(){console.log("Thất bại !!")})}function l(){n.get("api/purchaseInvoice/getPartialStorageByInwardStock/"+a.id,null,function(n){t.listPartialStorageByInwardStock=n.data;for(var a=0,o=0;o<t.listPartialStorageByInwardStock.length;o++)t.listPartialStorageByInwardStock[o].stt=o+1,t.listPartialStorageByInwardStock[o].displayReturn2="block",a+=t.listPartialStorageByInwardStock[o].TotalPurchaseQuantity,0===t.listPartialStorageByInwardStock[o].Status||1===t.listPartialStorageByInwardStock[o].Status?t.listPartialStorageByInwardStock[o].displayReturn2="block":2===t.listPartialStorageByInwardStock[o].Status&&(t.listPartialStorageByInwardStock[o].displayReturn2="none"),null===t.listPartialStorageByInwardStock[o].INVoucherDate&&(t.listPartialStorageByInwardStock[o].INVoucherDate="_ _ /_ _ /_ _");if(t.inwardStock.TotalPurchaseQuantity<=a){t.displayInward="none",t.inwardStock.tt="Đã nhập kho",t.inwardStock.cs="available";for(var e=0;e<t.listPartialStorageByInwardStock.length;e++)t.listPartialStorageByInwardStock[e].displayReturn2="none";t.displayReturn1="block"}else t.displayInward="block"},function(){console.log("Thất bại !!")})}function d(){n.get("api/purchaseInvoice/getCashPaymentByInwardStock/"+a.id,null,function(n){if(t.listCashPayment=n.data,t.listCashPayment.length<=0)t.displayPayment="none";else{t.displayPayment="block";for(var a=0;a<t.listCashPayment.length;a++)null===t.listCashPayment[a].INVoucherDate&&(t.listCashPayment[a].INVoucherDate="_ _ /_ _ /_ _")}},function(){console.log("Thất bại !!")})}function s(){n.get("api/purchaseInvoice/getInvoiceByInwardStock/"+a.id,null,function(n){t.listInvoiceByInwardStock=n.data;for(var a=0,o=0;o<t.listInvoiceByInwardStock.length;o++)t.listInvoiceByInwardStock[o].stt=o+1,1===t.listInvoiceByInwardStock[o].PaymentStatus?(t.listInvoiceByInwardStock[o].displayPayment1="block",t.listInvoiceByInwardStock[o].displayPayment2="none"):(t.listInvoiceByInwardStock[o].displayPayment1="none",t.listInvoiceByInwardStock[o].displayPayment2="block"),null===t.listInvoiceByInwardStock[o].INVoucherDate&&(t.listInvoiceByInwardStock[o].INVoucherDate="_ _ /_ _ /_ _"),a+=t.listInvoiceByInwardStock[o].TotalPaymentAmount;t.inwardStock.TotalPaymentAmount<=a?t.displayInvoice="none":t.displayInvoice="block"},function(){console.log("Thất bại !!")})}function h(){var t=document.getElementById("dvContents").innerHTML,n=document.createElement("iframe");n.name="frame1",n.style.position="absolute",n.style.top="-1000000px",document.body.appendChild(n);var a=n.contentWindow?n.contentWindow:n.contentDocument.document?n.contentDocument.document:n.contentDocument;return a.document.open(),a.document.write("<html><head><title>Tiktac.vn</title>"),a.document.write("</head><body>"),a.document.write(t),a.document.write("</body></html>"),a.document.close(),setTimeout(function(){window.frames.frame1.focus(),window.frames.frame1.print(),document.body.removeChild(n)},500),!1}function I(a,e,i){if(a<t.voucherDetail.length){var c={};if(t.voucherDetail[a].maxquantity=t.voucherDetail[a].Quantity,e.length>0)for(var r=0;r<e.length;r++)t.voucherDetail[a].ItemID===e[r].ItemID&&(t.voucherDetail[a].maxquantity=t.voucherDetail[a].maxquantity-e[r].Quantity);t.voucherDetail[a].maxquantity>0?(c.VoucherID=i,c.ItemID=t.voucherDetail[a].ItemID,c.Quantity=t.voucherDetail[a].maxquantity,c.UnitPrice=t.voucherDetail[a].UnitPrice,c.DiscountRate=t.voucherDetail[a].DiscountRate,c.DiscountAmount=c.DiscountRate*(c.Quantity*c.UnitPrice)/100,c.VATRate=t.voucherDetail[a].VATRate,c.Amount=c.Quantity*c.UnitPrice-c.DiscountAmount,n.post("api/purchaseInvDetail/create",c,function(){I(a+1,e,i),console.log("Thêm chi tiết đơn nhận hàng thành công")},function(){console.log("Thêm chi tiết đơn nhận hàng không thành công.")})):I(a+1,e,i)}else{var u={BranchID:t.aps.BranchID,voucherID:t.aps.VoucherID};n.put("api/stock/updateClosingQuantity",u,function(){console.log("cập nhật tồn kho thành công !!")},function(t){console.log(t)}),t.GetVoucherById(),o.displaySuccess("Nhập kho đã hoàn thành !!")}}function y(t){n.get("api/purchaseInvDetail/getPartialStorageDetail/"+a.id,null,function(n){var a=[];a=n.data,I(0,a,t)},function(){console.log("Failed !!")})}function S(){var a={};if(a.ObjectID=t.inwardStock.ObjectID,a.OriginalVoucherNo=t.inwardStock.INVoucherNo,a.InwardStockID=t.inwardStock.VoucherID,a.StockImportStatus=1,a.BranchID=t.inwardStock.BranchID,a.INVoucherDate=new Date,t.listPartialStorageByInwardStock.length<=0)a.TotalPaymentAmount=t.inwardStock.TotalPaymentAmount,a.TotalPurchaseQuantity=t.inwardStock.TotalPurchaseQuantity;else{a.TotalPaymentAmount=t.inwardStock.TotalPaymentAmount,a.TotalPurchaseQuantity=t.inwardStock.TotalPurchaseQuantity;for(var e=0;e<t.listPartialStorageByInwardStock.length;e++)a.TotalPaymentAmount=a.TotalPaymentAmount-t.listPartialStorageByInwardStock[e].TotalPaymentAmount,a.TotalPurchaseQuantity=a.TotalPurchaseQuantity-t.listPartialStorageByInwardStock[e].TotalPurchaseQuantity}n.post("api/purchaseInvoice/createPartialStorage",a,function(a){t.aps=a.data,t.AddPartialStorageDetail(t.aps.VoucherID),t.inwardStock.Status=1,t.inwardStock.INVoucherDate=new Date,t.inwardStock.StockImportStatus=2,n.put("api/purchaseInvoice/update",t.inwardStock,function(){},function(){o.displayError("Thất bại !!")})},function(){o.displayError("Nhập kho không thành công.")})}function m(a){n.get("api/purchaseInvoice/getbyid/"+a,null,function(a){var e={};e=a.data,e.PaymentStatus=1,e.INVoucherDate=new Date,n.put("api/purchaseInvoice/update",e,function(){if(o.displaySuccess("Hóa đơn được thanh toán !!"),t.inwardStock.PaymentStatus=1,n.put("api/purchaseInvoice/update",t.inwardStock,function(){t.GetVoucherById(),t.AddCashPayment(e.TotalPaymentAmount)},function(){o.displayError("Thất bại !!")}),null!==t.inwardStock.ObjectID){var a={};n.get("api/vendor/getbyid/"+t.inwardStock.ObjectID,null,function(o){a=o.data,a.ObjectID===t.inwardStock.ObjectID&&(0===a.Debt?a.Debt=a.Debt:a.Debt=a.Debt-t.invoice.TotalPaymentAmount,n.put("api/vendor/update",a))},function(){o.displayError("Thất bại !!")})}},function(){o.displayError("Cập nhật không thành công.")})},function(){console.log("load items failed")})}function p(a){var e={};e.ObjectID=t.inwardStock.ObjectID,e.BranchID=t.inwardStock.BranchID,e.OriginalVoucherNo=t.inwardStock.INVoucherNo,e.InwardStockID=t.inwardStock.VoucherID,e.VoucherType=40,e.Status=0,e.TotalAmount=a,e.TotalAmountOC=a,e.Description="Trả tiền cho nhà cung cấp khi nhập hàng",e.INVoucherDate=new Date,n.post("api/purchaseInvoice/createCashPayment",e,function(){},function(){o.displayError("Không tạo được phiếu chi !!")})}function D(o){n.get("api/purchaseInvDetail/getpurchaseinvoicedetail/"+a.id,null,function(a){var e=[];e=a.data;for(var i=0;i<t.voucherDetail.length;i++){var c={};if(t.voucherDetail[i].maxquantity=t.voucherDetail[i].Quantity,e.length>0)for(var r=0;r<e.length;r++)t.voucherDetail[i].ItemID===e[r].ItemID&&(t.voucherDetail[i].maxquantity=t.voucherDetail[i].maxquantity-e[r].Quantity);c.VoucherID=o,c.ItemID=t.voucherDetail[i].ItemID,c.Quantity=t.voucherDetail[i].maxquantity,c.UnitPrice=t.voucherDetail[i].UnitPrice,c.DiscountRate=t.voucherDetail[i].DiscountRate,c.DiscountAmount=c.DiscountRate*(c.Quantity*c.UnitPrice)/100,c.VATRate=t.voucherDetail[i].VATRate,c.Amount=c.Quantity*c.UnitPrice-c.DiscountAmount,n.post("api/purchaseInvDetail/create",c,function(){console.log("Thêm chi tiết hóa đơn thành công")},function(){console.log("Thêm chi tiết hóa đơn không thành công.")})}},function(){console.log("Failed !!")})}function k(){var a={};if(a.ObjectID=t.inwardStock.ObjectID,a.OriginalVoucherNo=t.inwardStock.INVoucherNo,a.DeliveryDate=t.inwardStock.DeliveryDate,a.InwardStockID=t.inwardStock.VoucherID,a.PaymentStatus=0,a.BranchID=t.inwardStock.BranchID,a.Status=0,t.listInvoiceByInwardStock.length<=0)a.TotalPaymentAmount=t.inwardStock.TotalPaymentAmount,a.TotalPurchaseQuantity=t.inwardStock.TotalPurchaseQuantity,a.TotalAmount=t.inwardStock.TotalAmount,a.TotalVATAmount=t.inwardStock.TotalVATAmount,a.TotalDiscountAmount=t.inwardStock.TotalDiscountAmount,a.DiscountForInvoice=t.inwardStock.DiscountForInvoice;else{a.TotalPaymentAmount=t.inwardStock.TotalPaymentAmount,a.TotalPurchaseQuantity=t.inwardStock.TotalPurchaseQuantity,a.TotalAmount=t.inwardStock.TotalAmount,a.TotalVATAmount=t.inwardStock.TotalVATAmount,a.TotalDiscountAmount=t.inwardStock.TotalDiscountAmount,a.DiscountForInvoice=t.inwardStock.DiscountForInvoice;for(var e=0;e<t.listInvoiceByInwardStock.length;e++)a.TotalPaymentAmount=a.TotalPaymentAmount-t.listInvoiceByInwardStock[e].TotalPaymentAmount,a.TotalPurchaseQuantity=a.TotalPurchaseQuantity-t.listInvoiceByInwardStock[e].TotalPurchaseQuantity,a.TotalAmount=a.TotalAmount-t.listInvoiceByInwardStock[e].TotalAmount,a.TotalVATAmount=a.TotalVATAmount-t.listInvoiceByInwardStock[e].TotalVATAmount,a.TotalDiscountAmount=a.TotalDiscountAmount-t.listInvoiceByInwardStock[e].TotalDiscountAmount,a.DiscountForInvoice=a.DiscountForInvoice-t.listInvoiceByInwardStock[e].DiscountForInvoice}n.post("api/purchaseInvoice/createInv",a,function(a){var e=a.data;if(t.AddInvoiceFullDetail(e.VoucherID),o.displaySuccess("Đã xuất hóa đơn !!"),t.inwardStock.InvoiceExportStatus=2,n.put("api/purchaseInvoice/update",t.inwardStock,function(){t.GetVoucherById()},function(){o.displayError("Thất bại !!")}),null!==t.inwardStock.ObjectID){var i={};n.get("api/vendor/getbyid/"+t.inwardStock.ObjectID,null,function(a){i=a.data,i.ObjectID===t.inwardStock.ObjectID&&(i.Debt=i.Debt+t.hoadon.TotalPaymentAmount,n.put("api/vendor/update",i))},function(){o.displayError("Thất bại !!")})}},function(){o.displayError("Thêm mới không thành công.")})}function g(t){e.confirm("<h4>Bạn có chắc muốn xóa?</h4>").then(function(){var a={params:{id:t}};n.get("api/purchaseInvoice/getbyid/"+t,null,function(t){var e={};e=t.data,0===e.PaymentStatus&&0===e.StockImportStatus&&0===e.InvoiceExportStatus?n.del("api/purchaseInvoice/deleteInwardStock",a,function(){o.displaySuccess("Xóa thành công"),i.go("inwardStock")},function(){o.displayError("Xóa không thành công")}):o.displayWarning("Phiếu nhập đã phát sinh giao dịch. Không thể xóa phiếu nhập này !!")},function(){console.log("load items failed")})})}function v(){n.get("api/vendor/getall",null,function(n){t.listVendor=n.data;for(var a=0;a<n.data.length;a++)t.inwardStock.ObjectID===t.listVendor[a].ObjectID&&(t.inwardStock.ObjectName=t.listVendor[a].ObjectName,t.inwardStock.ObjectAddress=t.listVendor[a].ObjectAddress,t.inwardStock.Tel=t.listVendor[a].Tel,t.inwardStock.Email=t.listVendor[a].Email,t.inwardStock.ObjectAddress=t.listVendor[a].ObjectAddress)},function(){console.log("load items failed")})}function w(){n.get("api/purchaseInvDetail/getbyid/"+a.id,null,function(n){t.voucherDetail=n.data,t.getItem()},function(t){o.displayError(t.data)})}function f(){n.get("api/positem/getall",null,function(n){t.listItemOpt=n.data;for(var a=0;a<t.voucherDetail.length;a++)for(var o=0;o<n.data.length;o++)t.voucherDetail[a].ItemID===t.listItemOpt[o].ID&&(t.voucherDetail[a].ItemName=t.listItemOpt[o].Name,t.voucherDetail[a].SKU_Code=t.listItemOpt[o].SKU)},function(){console.log("load items failed")})}function P(){n.get("api/purchaseInvoice/getbyid/"+a.id,null,function(n){t.inwardStock=n.data,1===t.inwardStock.Status&&(t.inwardStock.tt="Đã nhập kho",t.inwardStock.cs="available"),0===t.inwardStock.Status&&(t.inwardStock.tt="Chờ nhập kho",t.inwardStock.cs="not-available"),2===t.inwardStock.Status&&(t.inwardStock.tt="Đang nhập kho",t.inwardStock.cs="blue"),t.GetVendor(),t.getInvoiceByInwardStock(),t.GetCashPaymentByInwardStock(),t.getPartialStorageByInwardStock(),t.getPurchaseReturnByISID()},function(t){o.displayError(t.data)})}t.inwardStock={VoucherID:null,INVoucherNo:null,Status:null},t.GetVoucherById=P,t.GetVoucherDetail=w,t.voucherDetail=[],t.getItem=f,t.listItemOpt=[],t.GetVendor=v,t.listVendor=[],t.deleteVoucher=g,t.HoaDonToanBo=k,t.AddInvoiceFullDetail=D,t.ThanhToan=m,t.AddCashPayment=p,t.GetCashPaymentByInwardStock=d,t.listCashPayment=[],t.NhapKhoToanBo=S,t.AddPartialStorageDetail=y,t.aps={},t.displayInvoice="",t.displayPayment="none",t.displayInward="",t.displayReturn="none",t.displayReturn1="none",t.PrintDiv=h,t.getInvoiceByInwardStock=s,t.listInvoiceByInwardStock=[],t.getPartialStorageByInwardStock=l,t.listPartialStorageByInwardStock=[],t.listPartialStorageDetail=[],t.getPurchaseReturnByISID=u,t.listPurchaseReturnByISID=[],t.deleteInvoice=r,t.BtnEdit_Click=c,t.AddDetail=I,t.GetVoucherById(),t.GetVoucherDetail()}t.controller("inwardStockDetailsController",n),n.$inject=["$scope","apiService","$stateParams","notificationService","$ngBootbox","$state"]}(angular.module("tiktak.inwardStock"));